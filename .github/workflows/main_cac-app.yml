name: 'Build and deploy Python app to Azure Web App: cac-app'

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Print simple Python message
      run: |
        python -c "print('Hallo Roger üëã')"
        python -c "import os; print(os.environ.get('DB_NAME')=='cac_db')"
        python -c "import os; print(os.environ.get('DB_USER')=='cac_db_admin@cacsqlserver')"
        python -c "import os; print(os.environ.get('DB_HOST')=='cacsqlserver.database.windows.net')"
      env:
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        DB_HOST: ${{ secrets.DB_HOST }}

    - name: DNS Test
      run: nslookup cacsqlserver.database.windows.net
    - name: Debug DB connection settings
      run: |
        if [ "$DB_NAME" = "cac_db" ]; then
          echo "‚úÖ DB_NAME is correct: $DB_NAME"
        else
          echo "‚ùå DB_NAME is incorrect: $DB_NAME"
        fi

        if [ "$DB_HOST" = "cacsqlserver.database.windows.net" ]; then
          echo "‚úÖ DB_HOST is correct: $DB_HOST"
        else
          echo "‚ùå DB_HOST is incorrect: $DB_HOST"
        fi

        if [ "$DB_USER" = "cac_db_admin@cacsqlserver" ]; then
          echo "‚úÖ DB_USER is correct: $DB_USER"
        else
          echo "‚ùå DB_USER is incorrect: $DB_USER"
        fi
      env:
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_USER: ${{ secrets.DB_USER }}

    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python version
      uses: actions/setup-python@v4
      with:
        python-version: '3.11.14'

    - name: Install ODBC Driver for SQL Server
      run: |
        sudo apt-get update
        sudo apt-get install -y curl gnupg
        curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
        curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
        sudo apt-get install -y unixodbc
        sudo apt-get update
        sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18 unixodbc-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r requirements.txt

    - name: Test Database Connection
      run: python azure_iaac/test_db_connection.py
      env:
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        DB_HOST: ${{ secrets.DB_HOST }}

    - name: Test Database Connection
      run: |
        python -c "import pyodbc; print(pyodbc.drivers())"
      env:
        DB_HOST: ${{ secrets.DB_HOST }}
        
    - name: Run Django migrations
      timeout-minutes: 5
      env:
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        DB_HOST: ${{ secrets.DB_HOST }}
        DJANGO_ENV: production
        
      run: |
        python manage.py migrate

    - name: Collect static files
      env:
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_PORT: ${{ secrets.DB_PORT }}
        DJANGO_ENV: production
      run: |
        python manage.py collectstatic --noinput

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: 'cac-app'
        slot-name: 'production'
        publish-profile: ${{ secrets.AzureAppService_PublishProfile_8fe69e4d5cc64a699fb541acedc197d5 }}
        package: .
